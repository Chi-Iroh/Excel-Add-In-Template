# <a id="top"></a> Setup Office Add-In
## [Go to Useful Links](#useful-links-link)
## [Gitea info](#gitea-info-link)
## [Typedoc info](#typedoc-info-link)
## [Go to Microsoft auto-generated README](#microsoft-readme)

<br>

## Introduction

Office suite (Excel, Word etc..) supports add-ins, either in web or desktop app (app is Windows-only).  
This document will explain how to create one using Office JavaScript API, step by step.  
A dual boot (Windows 10 / Ubuntu 22.04 LTS) was used but steps shouldn't be OS-dependant.  

## Two Ways

This tutorial shows how to directly start using this template.  
It was created by improving an autogenerated project by Yeoman (more details below), and all these steps are covered here.  
Even if you don't care much about this process, below sections are still worth to be read, as they explain important concepts.  
It's strongly advised take a look at them.  

## Setup NodeJS and NPM

To run JavaScript we need NodeJS runtime and NPM (Node Package Manager), but Office API requires specific versions.  
These versions are listed in the root of <a href="package.json">package.json</a> :  
```json
"engines": {
  "node": ">=16 <19",
  "npm": ">=7 <10"
}
```

As I write this documentation, the requirements are as shown above, and they're not latest available versions.  
I strongly recommand using [nvm](https://github.com/nvm-sh/nvm), as it eases downloading old releases.  
I'm only covering installation with `nvm` here, feel free to do it by yourself but you won't have any help here.  

First, install `nvm` by following its GitHub documentation.  
Install any `node` version, according to the requirements, with `nvm install <version>`.  
Check your `npm` version with `npm --version`, and downgrade it if necessary with command `npm install -g npm@<version>`.  
NPM versions can be found [here](https://www.npmjs.com/package/npm?activeTab=versions).  

## Setup

Run `npm install` to download and setup dependencies.  
To enable both commit message checking and automatic documentation generation hooks : `./hooks/setup.sh`.  
<b>Important:</b> This script <ins>only</ins> can be executed in <ins>project root</ins> or <ins>hooks</ins> directory.  

## Optional Step : Creating a Partition for Testing Purposes ([skip](#after-partition))

In a dual boot environment, it is interesting to make a partition which can be accessed from both Windows and another OS, so that the add-in can be tested easily on multiple platforms and in web or app mode.  

### Partition Requirements

The filesystem must support multiple OSes :
* NTFS : recent, Windows and Linux only
* FAT32 : older, but supported almost anywhere (including MacOS)

Partition size hasn't to be very big, <ins>a gigabyte</ins> is enough and you'll still have a few hundreds megabytes left for assets or other JS frameworks.  

To shrink a partition and make space for this one, follow [this guide](https://access.redhat.com/articles/1196333) (Linux + e2fsck + resize2fs).  

A partition can be created either using a GUI (not covered here) or in the terminal (fdisk and mkfs are explained).  

### Creating the Partition (Linux + fdisk)

Using fdisk, here's the steps (assuming there's some unallocated space in a disk) :  

| Prompt | Command | Explanation |
| :----- | :-----: | :---------: |
| None | `sudo fdisk /dev/XXX` | Opens the disk.  |
| `Command (m for help):` | `n` | Adds a new partition.  |
| `Partition number (...):` | `[Enter]` | Sets the partition number to Y (entering another number than the one proposed is OK, it will only affect device filename). Will create later a device block named `/dev/sdaY` or `/dev/nvmeAnB/Y` depending of disk type. |
| `First sector (...):` | `[Enter]` | Makes the partition begin right at the beginning of unallocated region in the disk. |
| `Last sector, +sectors or +size (...):` | `+XM` or `+XG` | Reserves X megabytes or gigabytes (1GB = 1024MB). |
| `Command (m for help):` | `t` | Partition type must be changed to be recognized by Windows. |
| `Partition number (...):` | `[Enter] or [partition number]` | Selects the partition number X. |
| `Partition type or alias (type L to list all):` | `11` (Microsoft basic data) | Partition will be recognized and automatically mounted on Windows. When typing L to see all the types, it opens a vim-like list which must be exited by entering `q`. |
| `Command (m for help):` | `w` | Applies the changes onto the disk. |

### Creating the Filesystem (Linux + mkfs)

The partition is created but cannot be used until it has a filesystem :
* NTFS : `mkfs.ntfs [-L LABEL] [-f]` : -f is for quick format (full format is long)
* FAT32 : `mkfs.fat -F 32 [-n LABEL]`

The partition is now ready.  

## Generating Project Tree <a id="after-partition"></a>

Yeoman is a Microsoft tool to automatically generate projects from sets of rules called generators.  
Below sections will explain how to enhance its generated project structure and make it ready-to-use.  
Firstly, Node.js must be installed.  
Then Yeoman will be used to generate the project, it must be installed alongside Office add-in generator like this : `npm install -g yo generator-office`.  
Run yeoman : `yo office` (no need to create the project directory by yourself, Yeoman will do it).  
It will let you choose between several project types : choose <ins>Excel Custom Functions using a Shared Runtime </ins>.  
Then comes the language (JavaScript or TypeScript), the project name and the application supported (Word, Excel etc..).  

<a id="excel-addin-picture"></a>
<img src="assets/doc//Excel Add-in.png" alt="Custom add-in logo is on top right corner of Excel (in Home) -- Taskpane is on the right side.">

Note: <ins>Excel Custom Functions using a Shared Runtime</ins> provides both a taskpane and custom functions, whereas <ins>Office Add-in Task Pane project</ins> only provides a taskpane.  

## Everything Starts from `manifest.xml` <a id="everything-starts-from-manifest"></a>

The file <a href="manifest.xml">manifest.xml</a> describes the add-in and contains :
* Layout
* Titles and texts
* Icons
* Links between Excel and taskpane / custom functions
* Other small details (locale, version, provider name ...)

It's the <ins>very first file loaded by Excel</ins>, thus it <b><ins>must</ins></b> be valid.  
See [here](https://learn.microsoft.com/en-us/office/dev/add-ins/develop/xml-manifest-overview?tabs=tabid-1) for the manifest reference.  
As an example, I deliberately caused an error in it :  

```xml
<Hosts>
    <Host Name="Workbook"/>
<!-- I removed '</Hosts>' here -->
```
Here's what I got when trying to start in web app :
```
Debugging is being started...
App type: web
Error: Unable to start debugging.
Error: Unable to parse the manifest file: manifest.xml. 
Error: Unexpected close tag
Line: 117
Column: 12
Char: >
```

`npm run validate` is a `npm` script to check whether the manifest is valid or not. This script is automatically ran before starting debugging, and aborts if fails.  
So the above output is what displays `npm run validate` with this erroneous manifest.  
Here's what happens when forcing the upload of a bad manifest directly in Excel web UI :  
<img src="assets/doc/error%20your%20add-in%20manifest%20is%20not%20valid.png" alt="ERROR - Your add-in manifest is not valid.">

A complete reference of the manifest is available [here](https://learn.microsoft.com/en-us/javascript/api/manifest?view=common-js-preview).  

### A word about icons <a id="a-word-about-icons"></a>

Even if `npm run validate` seems efficient, icons are not correctly handled and checked as it should be.  
[Microsoft documentation](https://learn.microsoft.com/en-us/javascript/api/manifest/icon?view=common-js-preview#image) states :
> The size attribute indicates the size in pixels of the image. Three image sizes are required (16, 32, and 80 pixels) while five other sizes are supported (20, 24, 40, 48, and 64 pixels).

Although the documentation list only 5 other supported sizes, there may probably be more, as Yeoman generated a manifest with a 128px-wide icon.  
Thus if you need another size, I recommend you to try and see if both Excel web and desktop app support it.  
Messing with icons requirements <ins>will</ins> lead to an error in desktop app (see [here](#this-add-in-no-longer-available)), but the web version won't complain.  

## Understanding Project Tree

We've discussed [previously](everything-starts-from-manifest) about the manifest, but let's talk about other files :  
* .eslintrc.json : config file for ESLint (static code analyzer)
* .nmprc : config file for `npm`
* babel.config.json : config file for <ins>Babel</ins>, a JavaScript compiler which job is to ensure backward compatibility with older browsers (converts recent code to older equivalent one)
* CONTRIBUTING.md : links for issues and pull requests of Microsoft's Github repositories
* LICENSE : legal license (MIT)
* manifest.xml : main config file, the identity of the add-in (see [above](#everything-starts-from-manifest))
* package(-lock).json : `npm`'s packages list
* README.md : Microsoft README, copied at the very end of this one (has some useful links)
* SECURITY.md : advices on reporting security issues
* tsconfig.json : config file of the compiler
* webpack.config.json : config file of local server (more details [below](#how-does-an-officejs-addin-run))
* assets/ : icons
* node_modules/ : JavaScript modules downloaded with `npm`
* src/ : source files
* src/commands/ : a single source file which implements add-in commands (buttons in some Excel menus, see [here](https://github.com/OfficeDev/office-js-docs-pr/blob/main/docs/design/add-in-commands.md))
* src/functions/ : a single source file (there used to be also a HTML file in older version) implementing custom functions
* src/taskpane/ :
* + taskpane.html|.css : two files representing the appearance of the taskpane
* + taskpane.js/ts : a single source file which is the back-end of the taskpane, which is able to fetch HTML elements from it and apply changes to them

## How Does an Office.js Add-In Run ? <a id="how-does-an-officejs-addin-run"></a>

First of all, the manifest is very important as it is the only file that Excel needs to run the add-in.  
But, one might ask, how can the code in src/ directory be executed ?  
Well, even if the manifest is all what Excel needs, it contains links to our files (icons, taskpane, commands and functions), meaning that they must be somewhere where Excel can access using HTTP requests.  
In development mode, we wish to test the add-in on a single machine, thus the files should be local.  
Here comes `webpack` : it's a local server which deploys built files on localhost and allows Excel to access them.  

## Configuring the Compiler

```typescript
// tsconfig.json
{
    "compilerOptions": {
        "strict": true,     // More type-checking
        "forceConsistentCasingInFileNames": true,   // Some OSes (like Windows) treat lowercase and uppercase characters in the same way, this option forces to use the exact name and casing for compatibility purposes.
        "downlevelIteration": true,   // Will generate more portable JavaScript code, for older versions
        ...
    }
}
```

## Build Process

In TypeScript only, there's an extra step before the common procedure, called the <ins>transpilation</ins>.  
It's basically a conversion of TypeScript code into JavaScript by the TypeScript compiler (`tsc`), which also performs a bunch of checks on types (what makes it safer than JavaScript).  
Then `webpack` runs the build process and <ins>minifies</ins> our files, by reducing their size as much as possible, to make them take less space and faster to parse by browsers, resulting in a shorter loading time.  
There are also <ins>.js.map</ins> files, they are map between minified files symbols (variables and functions) and sources to help debug errors in production.  
When an error will be raised, the map files permits to the browser to display where it happened in the original source code, with the proper function name, instead of these cryptic identifiers in minified files.  
The file <a href="dist/polyfill.js">polyfill.js</a> implements ES6 features for compatibility purposes, as some old browsers don't support it.  

Note: the manifest <ins>isn't</ins> checked in build phase, only before starting Excel, therefore the built manifest may be erroneous.  

## Portability

As shown [here](#a-word-about-icons), Excel web has some non-standard behaviors regarding the official documentation, whereas the desktop app seems to be pedantic and fully standard-compliant.  
Same thing if it must run on mobile devices, there may be extra requirements to fulfill.  

## Proxy Objects and Context

To understand how Office API works, some definitions are essential.  
First, the application (Excel, Word or whatever) is called the <ins>server</ins>.  
Even if the desktop app isn't a real server like on the web, using the same word is more convenient.  

Then, there are proxies.  
For optimization purposes, when using an Office-related object, this one is empty.  
One can create it properties, but cannot read anything.  
As an example :  

```typescript
let image = worksheet.shapes.addImage(base64Image);
image.name = "First image"; // OK, creates a property 'name'
console.log(image.width, "pixels wide"); // Bad, remember that the object is empty
```

When running this code, the `console.log` will throw this error :
> RichApi.Error: The property 'width' is not available. Before reading the property's value, call the load method on the containing object and call "context.sync()" on the associated request context.

This message is likely to be confusing if one doesn't understand Office internal mechanism.  
As said above, a proxy object is empty, for performance concerns, but it's not very convenient not to read its properties.  
When creating an image, it has a width and a height, but the proxy doesn't give us the access.  
That's when `call the load method` explains everything :  

```typescript
let image = worksheet.shapes.addImage(base64Image);
image.load("width"); // asks the proxy to load the 'width' property
console.log(image.width, "pixels wide"); // OK, access is granted to the 'width' property
```

In short, a proxy is a regular empty object, which allows any write access (including creating new properties which aren't in the original object), but blocks any read access because the requested property hasn't be loaded, hence the `object.load(property)` method.  

Last, let's explain the later part in the error message : `call "context.sync()" on the associated request context`.  
A bit more of explanation is needed before diving into this part, so for now we'd like to perform some operations with the previous image :  

```typescript
image.width = ...;
image.height = ...;
image.name = ...;
image.altTextTitle = ...;
image.lockAspectRatio = ...;
image.placement = ...;
image.incrementLeft(...);
image.incrementTop(...);
image.incrementRotation(...);
```

Here, `image` is a proxy, hence an empty object, to an image object.  
We can add it properties like a normal object, <ins>but</ins> these changes <ins>will only be applied on next context.sync()</ins>.  
Office add-ins communicates with the <ins>server</ins> via the <ins>context</ins>.  
Basically, it's just a queue of pending operations on Office objects (like the image in above snippets).  
Once again for optimization purposes, any operation on Office object (every statement in the snippet right above) isn't executed, but added to the context queue.  
That means the above code doesn't change anything to the image, and this is obviously a problem.  
To fix this issue, one needs to add the statement `await context.sync()` after these statements, it tells the context to synchronize the server and the client, and pushes the queue to the server, which executes all the operations in it.  
The queue follows the FIFO principle, standing for *First In, First Out*, so there are executed in they appear in the source (contrary to a *Last In First Out* (LIFO) stack, which would have executed operations in reverse order).  
Be careful, `context.sync()` is asynchronous, and thus needs to be `await`ed.  

Let's go back to the issue with read access on proxies, the error message said `call "context.sync()" on the associated request context`.  
The `load` method sends a request to the server in order to get the value of the given property.  
As `load` is an Office-related object, it is locked by the context, thus `context.sync()` is mandatory to get read access.  

Also, take note that it seems necessary to end each function using Office objects by a `context.sync()`, as it crashes in the next synchronization, probably because it sends statements using deleted variables (local to the function).  

## Running Unit Tests

`npm install --save-dev jest @types/jest ts-jest`  
* `jest` : Unit test framework (Javascript)  
* `ts-jest` : Typescript support  
* `@types/jest` or `@jest/globals` : Functions (`test`, `expect` etc..).   
  Note that you need to import them when using `@jest/globals`, but not with `@types/jest`.  
  Note that `@types/jest` may not be up-to-date (but still very recent), contrary to `@jest/globals` which is the latest version.  

```typescript
// jest.config.json
{
    "preset": "ts-jest",        // Typescript support
    "testMatch": [ "**/*.ts" ], // Test all .ts files...
    "roots": ["tests/"],        // in "tests" directory
    "verbose": true             // Adds log for each test
}
```

```typescript
// package.json
{
    ...
    "scripts": {
        ...
        "tests" : "jest",    // "npm run tests" to run jest.
        ...
    }
}
```

### [Jest Testing API](https://jestjs.io/docs/api)  

### Troubleshoot : `ReferenceError: Office / Excel is not defined`

This error may be triggered by Jest when you test a function which is implemented in a file which contains `Office` or `Excel` in the global namespace or in some function/method called from the global namespace.  

```typescript
// Yeoman's auto-generated src/taskpane/taskpane.ts
Office.onReady((info) => {
    if (info.host === Office.HostType.Excel) {
        ...
    }
}
```

Jest (and any other unit test framework like `mocha`) can't find Office.js library because it's a single file in Microsoft's servers :  

```html
<!-- src/commands/commands.html -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
```

<a id="mock-explanation"></a>
Microsoft then released a package named `office-addin-mock` (should be installed with `npm install --save-dev`) which provides a mock object, aimed to be used for Office, Excel and other of their classes.  
A mock is a fake object which overrides the original one's behavior.  
In this situation it can help a lot , we may make a mock of an Excel worksheet and give it a bidimensionnal array of numbers, and then test our logic on it without using a real file.  
Here's how is an unit test :  

```typescript
// tests/helloworld.ts
import { OfficeMockObject } from "office-addin-mock";

// Overriding methods according to the needs.
const officeMock = {
  workbook: {
    range: {
      address: "C2:G3",
    },
    getSelectedRange: function () {
      return this.range;
    },
  },
  onReady: async function () {}
};

const mock = new OfficeMockObject(officeMock);
global.Office = mock as any; // as any is forced because the compiler will complain
// since the mock hasn't the exact same methods and members as the original Office class (here we didn't implement everything).

// importing our test, after the mock so that Office will be found.
import { helloworld } from "../src/taskpane/taskpane";

describe("Test", () => {
    test("Hello, World", () => {                    // it("Hello, World", ...) also exists and behaves exactly as 'test'
      expect(helloworld()).toBe("Hello, World !");
    });
})
```

Note: If the tested function is in a file without Office, Excel or something like that in the global namespace, it's not needed to create the mock nor move the import at the end.  
Also if you need to reset the mock between two tests, it may be better to use `require(...)` inside the test :  

```typescript
import { OfficeMockObject } from "office-addin-mock";
const officeMock = ...;

describe("Test", () => {
    test("Hello, World", () => {
        global.Office = new OfficeMockObject(officeMock) as any;
        const helloworld = require("../src/taskpane/taskpane.ts");
        expect(helloworld.helloworld()).toBe("Hello, World !");
    }) // 'test' is mandatory and contains your assertions...
}) // but 'describe' is optional and just groups some tests or other 'describe's. Nested 'describe's are useful for more accurate messages.
```

Here the mock can be reinitialized or setup differently between tests.  
There's an example on this [GitHub PR on OfficeDev repo](https://github.com/OfficeDev/Office-Addin-TaskPane/pull/136/files/bbd173c3185d39cf8b3ef6364ebf8dcec62f7347).

## More on Unit Tests and Mocks

As said previously, a mock is useful since it emulates an object, in this case because Excel API isn't available for testing.  
So for testing purposes, a minimal implementation of Excel is provided in <a href="tests/setup/setup.ts">tests/setup/setup.ts</a>.  
This mainly includes `Excel.Range` class, with a global bidimensionnal array acting as Excel worksheet.  
Constants `EXCEL_ROWS_MAX` and `EXCEL_COLUMNS_MAX` are redefined and lowered in this file to speed up tests, and thus can be changed again according to the needs.  
A minimal expression interpreter is provided, permitting to test expressions like `=A1+A2*A3+SQRT(A4)` (within the limits of what is implemented by Math.js).  
Here's how looks unit tests using setup.ts mocks :  

```typescript
// tests/someTest.ts
import "./setup/setup";
import { Cell } from "../src/cell/Cell"; // if needed, maybe accompanied with some other imports

test("someTest", () => {
  // Excel.RequestContext() simulates 'context' from src/taskpane/taskpane.ts
  const worksheet = new Excel.RequestContext().workbook.worksheets.getActiveWorksheet();
  const A1 = new Cell(worksheet, "A1");

  A1.setValue(1);
  A1.updateAllValues(); // explanation below
  expect(A1.getValue()).toBe(1);
  expect(new Cell(worksheet, "A1")).toBe(1); // the new instance retrieves the new value of A1
})
```

To simulate an Excel worksheet, there's a global bidimensionnal array (of either strings or numbers) in setup.ts.  
When `CellInstance.setValue(x)` is called, the internal Excel.Range object is updated, but only locally.  
To update the global array, one needs to call `CellInstance.updateAllValues()` if manipulating a `Cell` instance, or `ExcelRangeInstance.updateAllValues()` when directly using `Excel.Range` (`Cell` performs updating by calling its internal `Excel.Range`'s mock method).  
Note: Forgetting to call `.updateAllValues()` before an assertion is very likely to make the test fail.  

## Requesting an API and Dealing with CORS

Using a web API implies making requests to a (maybe external) server.  
For security reasons, most web browsers prevents a script (JavaScript or TypeScript backend) from requesting an external URL (an URL which is not in the same machine as the script).  
Whatever server it is, that means the owner didn't enable CORS, intentionally or not (if not, one should contact him).  
Useful resources :
* [Mozilla documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)
* [Setting up CORS on the most common servers](https://enable-cors.org/server.html)

## Common Errors and How to Fix Them

### How to Completely Reset and Reload an Add-In ? <a id="reset-add-in"></a>

Excel in the browser makes debugging harder, as it shows cryptic errors quite often, but many of them aren't related to the add-in's code.  
While the reason why these errors are triggered isn't clear, it's luckily straightforward to suppress them.  

* Browser-only : Clear website cookies and data (example on Firefox)
   <img src="assets/doc//sharepoint%20clear%20cookies%20and%20data.png" alt="Near URL bar, click on the locker and then 'Clear cookies and site data'.">
* Kill all instances of the server
* * Linux : `killall webpack`
* * Windows : `taskkill /f /im node.exe`
* Start again `webpack` using `npm start[:web]`

### `Cannot access manifest URL at https://127.0.0.1:3000/manifest.xml. Please ensure the url is accessible`

This error usually shows up due to missing or outdated certificates (`npm` package `office-addin-dev-certs` for dev (self-signed)).  

Otherwise, it may be caused by a misconfiguration of `webpack`.  
Check the existence of `Access-Control-Allow-Origin` and if the server is running on port 3000.  

```javascript
// webpack.config.js
const urlDev = "https://localhost:3000/";
...
module.exports = async (env, options) => {
  ...
  const config = {
    ...
    devServer: {
      ...
      headers: {
        "Access-Control-Allow-Origin": "*"
      }
    }
  }
}
```

### `currentUpdate is undefined`

<img src="assets/doc//error%20currentUpdate%20is%20undefined.png" alt="Error traceback">

This one sometimes happens when modifying a source file and then saving it : most of the time all works fine, `webpack` rebuilds and Excel doesn't complain, but the rest of the time it fails with this.  
It seems to mean that Excel hadn't correctly loaded everything, so just save you files again and if the error persists, refresh the page and in last resort [follow these instructions](#reset-add-in).  

### My Add-In is Displayed Multiple Times !

That's just a visual artifact which doesn't impact the code.  
A [complete reset](#reset-add-in) is needed to fix this.  

### `ADD-IN ERROR : This add-in is no longer available` <a id="this-add-in-no-longer-available"></a>

This error only seems to appear in the Windows desktop app, and indicates something wrong in <ins>manifest.xml</ins>.  
Try `npm run validate` to see whether or not your manifest is valid, and, of course, fix it if broken.  
However, things can get way more tricky when the previous command considers your manifest as valid, but the app doesn't.  
I guess there may be multiple ways to mess in the manifest and end up in this unpleasant situation, but I only found one way to do so.  
<a href="manifest.xml">manifest.xml</a> contains information about icons :

```xml
<!-- This section appears twice. -->
<Icon>
  <bt:Image size="16" resid="Icon.16x16"/>
  <bt:Image size="32" resid="Icon.32x32"/>
  <bt:Image size="64" resid="Icon.64x64"/>
  <bt:Image size="80" resid="Icon.80x80"/>
  <bt:Image size="128" resid="Icon.128x128"/>
  <bt:Image size="300" resid="Icon.300x300"/>
</Icon>

<!-- And this one only once. -->
<bt:Images>
  <bt:Image id="Icon.16x16" DefaultValue="https://localhost:3000/assets/icon-16.png"/>
  <bt:Image id="Icon.32x32" DefaultValue="https://localhost:3000/assets/icon-32.png"/>
  <bt:Image id="Icon.64x64" DefaultValue="https://localhost:3000/assets/icon-64.png"/>
  <bt:Image id="Icon.80x80" DefaultValue="https://localhost:3000/assets/icon-80.png"/>
  <bt:Image id="Icon.128x128" DefaultValue="https://localhost:3000/assets/icon-128.png"/>
  <bt:Image id="Icon.300x300" DefaultValue="https://localhost:3000/assets/icon-300.png"/>
</bt:Images>
```

As said earlier, the 300px icon wasn't in the generated project, so it's not mandatory at all, but 16px, 32px and 80px are (see [here](#a-word-about-icons)).  
I came across this problem just because I removed some of these, as I didn't use them, and luckily I only made a few changes compared to the working template.  
Unfortunately there's no magic, the only way to find what change Excel didn't like it to revert them all, one by one, until it works again.  
I strongly recommend to make a copy of your project into a temporary directory to avoid mistakes.  
I also wrote an answer on [StackOverflow](https://stackoverflow.com/questions/38689643/office-js-this-add-in-is-no-longer-available-error) about this problem.  

### `One or more add-ins failed to install or load custom functions` - `Error installing functions`

Surprisingly, the cause of this error comes from the manifest, in the field `Version` at the top :  
```xml
<?xml ... ?>
<OfficeApp ...>
  ...
  <Version>SomeVersion</Version>
</OfficeApp>
```

The version <ins>must</ins> be formatted as </ins>A.B.C.D</ins> (ex: 1.0.0.2).  
Even if it seems relatively straightforward, it becomes quite tricky when it's erroneous, as a version like <ins>1.0.2</ins> (missing fourth number) is incorrect but isn't detected by `npm run validate`, nor when uploading to Office Admin Center.  
Coming back to the issue, it is caused by a wrong version number (see this [GitHub issue](https://github.com/OfficeDev/office-js/issues/1630)), but only on web, the Windows desktop application doesn't complain and the add-in is still fully functional.  
The later point is quite confusing as the desktop applications has previously been fully compliant with Microsoft documentation, contrary to the web which isn't.  

### Another Error Shows up but Doesn't Seem Related to my Code !

Check once more if your code is ok, then [reset the add-in](#reset-add-in).  
If it breaks again, it's probably your fault, but if you think not, go to [Github issues](https://github.com/OfficeDev/Excel-Custom-Functions/issues) to look for information or create an issue.  

## Debugging

Debugging is quite straightforward using [Visual Studio](https://learn.microsoft.com/en-us/office/dev/add-ins/develop/debug-office-add-ins-in-visual-studio) or [Visual Studio Code extension](https://learn.microsoft.com/en-us/office/dev/add-ins/testing/debug-with-vs-extension), but without them it's a different story.  
Here I'll give some tips to ease debugging using Office web apps and browser console.  

We've previously seen error messages like `RichApi.Error : ...`, and the main issue with them is that they're not very explicit and don't give any information about the context or the faulty code statement.  
For example :  
> RichApi.Error: The argument is invalid or missing or has an incorrect format.

Office errors have an attribute which contains a bunch of useful information to track and fix faulty code :  
```typescript
OfficeExtension.config.extendedErrorLogging = true;
console.error(someError.debugInfo);
```

## How to Put in Production

### 2 Ways to Deploy

[Microsoft provides several ways to deploy an add-in.](https://learn.microsoft.com/en-us/office/dev/add-ins/publish/publish)  
According to the needs, an add-in can either be [publicly published on the official store](https://learn.microsoft.com/en-us/partner-center/marketplace/submit-to-appsource-via-partner-center) (not explained here), or be restrained to some people, often for companies.  
There are two ways to deploy in organizations (grant access to some people only), within [SharePoint](https://learn.microsoft.com/en-us/office/dev/add-ins/publish/publish-task-pane-and-content-add-ins-to-an-add-in-catalog) or the  [Microsoft 365 Admin Center](https://learn.microsoft.com/en-us/microsoft-365/admin/manage/test-and-deploy-microsoft-365-apps?view=o365-worldwide).
Be careful, Sharepoint catalog add-ins are only available on Sharepoint files in another editor, without Office add-ins.  
Thus it may be better to deploy it through the Microsoft 365 Admin Center to use it with other add-ins, also for portability reasons.  
That said, below walkthrough <ins>won't cover Sharepoint deployment</ins>.  

### Integrated App Deployment Walkthrough <a id="integrated-app-deployment-walkthrough"></a>

![Go to deployment menu](assets/doc/go%20to%20deployment%20menu.png)

First, let's go to  <a href="office.com">office.com</a> and log in with an administrator account.  
In the home screen, a sidebar should appear on the left, with icons of all Office apps, click on the icon "Admin", but if it isn't there, check the account permissions (<ins>left</ins> image).  
On this new page (<ins>middle</ins> image), go to "Settings", then "Integrated Apps" and "Upload Custom Apps" (<ins>right</ins> image).  

![Upload and validate the manifest](assets/doc/upload%20manifest.png)

To deploy the manifest, click on the drop-down menu and set the app type to "Office Add-In", then upload the manifest from a device or provide a link, and click on validate button.  
It seems to be the same validation as does `npm run validate`, thus if it can be started in development with command `npm run start`(npm start script checks the manifest before really starting the app, either in web or desktop app), it should be valid.  
<ins><b>Beware</b></ins> : It is obvious uploading the manifest from the device filesystem is a one-shot and the manifest isn't automatically refreshed, <ins> but Office will <b>never</b> refresh the manifest from the link neither, each time it is modified it <b>must</b> be uploaded again.</ins>).  

![Set users](assets/doc/deploy%20users.png)

This page allows to choose who will be able to use the add-in.  
It can either be only this administrator account ("Just me" option), the entire organization, or only some people ("Specific users/groups" option).  
The latter option has a text bar right below, write down the name of someone and their email will appear, then click on it to grant them access, and their names will appear below.  
For more information about users, go to [Integrated Apps Deployment](https://learn.microsoft.com/en-us/microsoft-365/admin/manage/test-and-deploy-microsoft-365-apps?view=o365-worldwide).  
Right beneath the add-in name and logo, there is the switch "Is this a test deployment ?" (disabled by default), it seems it only enables sort all custom add-ins and see which are test deployments.  
For more information, see this [GitHub issue](https://github.com/MicrosoftDocs/microsoft-365-docs/issues/9465).  

![Accept permissions needed by the add-in](assets/doc/deploy%20permissions.png)

It's just a simple message where it is said the add-in needs to read and write on an Excel document ("ReadWriteDocument" capability), and also send and receive data ("SendReceiveData" capability).  

![Finish deployment](assets/doc/deploy%20finish.png)

Here's a summary of the previous steps, and displays assigned users.  

![Deployment completed](assets/doc/deploy%20completed.png)

The add-in is successfully deployed, and there's a message inviting to inform users.  

![Add-in in Excel document](assets/doc/add-in%20in%20deployed%20in%20excel.png)

As the deployment is finished, when any previously authorized user opens Excel (either desktop app or web app) and is login with their business Microsoft account, the add-in should be appear in the "Home" tab, right near "Add-ins" (at the very right of the top tool bar").  

## Useful Links <a id="useful-links-link"></a>

* [Office add-ins documentation](https://learn.microsoft.com/en-us/office/dev/add-ins/)
* [Office add-ins documentation (Microsoft GitHub repo)](https://github.com/OfficeDev/office-js-docs-pr/tree/main/docs)
* [Excel JavaScript API overview](https://hongbo-miao.gitbooks.io/excel/content/tutorial/excel-add-ins-javascript-programming-overview.html)
* [Excel JavaScript API reference](https://learn.microsoft.com/en-us/office/dev/add-ins/reference/overview/excel-add-ins-reference-overview)
* [object.load nested properties (a.b.c)](https://stackoverflow.com/questions/48634531/how-to-avoid-too-many-context-loads-in-office-js)

## Glossary

* Context : runtime environment of the add-in, provides proxy objects as an interface with the server
* Mock : a fake object used for unit tests, which permits customization of its real behavior (see [here](#mock-explanation))
* Office.js : JavaScript Office API, used in this project. Worth to be precised, as there are multiple tools to create Office add-ins, which don't use JavaScript.
* Office Add-in : application running inside Office and using its API, useful for automation, for example
* Proxy object : a link which refers to a real object. Useful for optimization purposes, in our case it avoids loading the objects entirely, by letting the user manually load a property before using it.
* Taskpane : add-in window (on the right, see [picture](#excel-addin-picture))
* Server : a real server (in Office web), or the desktop application on Windows. The add-in is running in an isolated environment, and communicates with the server through the context.
* UDF : user-defined (custom) function

### [Go back to top](#top)

## Gitea Info <a id="gitea-info-link"></a>

This project was originally hosted on Gitea.  
[[BUG] Gitea cannot use relative file (not images) links](https://github.com/go-gitea/gitea/issues/18592)  
One should use \<a\> instead of \[\]\(\) for relative paths, but it doesn't seem to work well for now.  
The first three images in [the walkthrough](#integrated-app-deployment-walkthrough) ought to be displayed side-by-side, but Gitea doesn't seem to support well CSS.  
Here's the original code (as it is removed in the section and replaced by a single image) :
```html

<div style="display: flex;">
  <div>
    <img src="assets/doc/office apps sidebar.png" alt="Sidebar on office.com home page, on the left of the screen, which lists all Office apps (Word, Powerpoint etc..) and an icon for the admin centre (click on this).">
  </div>
  <div>
    <img src="assets/doc/integrated apps.png" alt="Menu of the admin centre, click on settings then integrated apps.">
  </div>
  <div>
    <img src="assets/doc/upload custom app.png" alt="Click on &quot;Upload custom apps&quot; (between &quot;Get apps&quot; and &quot;Refresh&quot;)">
  </div>
</div>
```
The 3 original images are kept in the repository.  

### [Go back to top](#top)

## Typedoc Info <a id="typedoc-info-link"></a>

<a href="doc">Documentation</a> is generated using [typedoc](https://typedoc.org/).  
Some pieces of information about typedoc :
* Images aren't displayed, hence README is disabled in generated doc, but still remains in project root directory
* Comments in <a href="src/taskpane/taskpane.ts">src/taskpane/taskpane.ts</a> doesn't seem to be detected (perhaps due to code in global namespace)

### [Go back to top](#top)

# Generic README by Microsoft <a id="microsoft-readme"></a>

<br>

## Custom functions in Excel

Custom functions enable you to add new functions to Excel by defining those functions in JavaScript as part of an add-in. Users within Excel can access custom functions just as they would any native function in Excel, such as `SUM()`.  

This repository contains the source code used by the [Yo Office generator](https://github.com/OfficeDev/generator-office) when you create a new custom functions project. You can also use this repository as a sample to base your own custom functions project from if you choose not to use the generator. For more detailed information about custom functions in Excel, see the [Custom functions overview](https://docs.microsoft.com/office/dev/add-ins/excel/custom-functions-overview) article in the Office Add-ins documentation or see the [additional resources](#additional-resources) section of this repository.

### Debugging custom functions

This template supports debugging custom functions from [Visual Studio Code](https://code.visualstudio.com/). For more information see [Custom functions debugging](https://aka.ms/custom-functions-debug). For general information on debugging task panes and other Office Add-in parts, see [Test and debug Office Add-ins](https://docs.microsoft.com/office/dev/add-ins/testing/test-debug-office-add-ins).

### Questions and comments

We'd love to get your feedback about this sample. You can send your feedback to us in the *Issues* section of this repository.

Questions about Office Add-ins development in general should be posted to [Microsoft Q&A](https://docs.microsoft.com/answers/questions/185087/questions-about-office-add-ins.html). If your question is about the Office JavaScript APIs, make sure it's tagged withÂ [office-js-dev].

### Join the Microsoft 365 Developer Program
Get a free sandbox, tools, and other resources you need to build solutions for the Microsoft 365 platform.
- [Free developer sandbox](https://developer.microsoft.com/microsoft-365/dev-program#Subscription) Get a free, renewable 90-day Microsoft 365 E5 developer subscription.
- [Sample data packs](https://developer.microsoft.com/microsoft-365/dev-program#Sample) Automatically configure your sandbox by installing user data and content to help you build your solutions.
- [Access to experts](https://developer.microsoft.com/microsoft-365/dev-program#Experts) Access community events to learn from Microsoft 365 experts.
- [Personalized recommendations](https://developer.microsoft.com/microsoft-365/dev-program#Recommendations) Find developer resources quickly from your personalized dashboard.

### Additional resources

* [Custom functions overview](https://docs.microsoft.com/office/dev/add-ins/excel/custom-functions-overview)
* [Custom functions best practices](https://docs.microsoft.com/office/dev/add-ins/excel/custom-functions-best-practices)
* [Custom functions runtime](https://docs.microsoft.com/office/dev/add-ins/excel/custom-functions-runtime)
* [Office Add-ins documentation](https://docs.microsoft.com/office/dev/add-ins/overview/office-add-ins)
* More Office Add-ins samples at [OfficeDev on Github](https://github.com/officedev)

This project has adopted the [Microsoft Open Source Code of Conduct](https://opensource.microsoft.com/codeofconduct/). For more information, see the [Code of Conduct FAQ](https://opensource.microsoft.com/codeofconduct/faq/) or contact [opencode@microsoft.com](mailto:opencode@microsoft.com) with any additional questions or comments.

### Copyright

Copyright (c) 2019 Microsoft Corporation. All rights reserved.

### [Go back to top](#top)